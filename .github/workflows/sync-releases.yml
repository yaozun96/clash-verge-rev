name: Sync Upstream Releases (Latest 3)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶æ£€æµ‹ä¸€æ¬¡ï¼Œå¯æ”¹æˆæ¯å¤©è‡ªåŠ¨æ‰§è¡Œ

permissions:
  contents: write

jobs:
  sync_releases:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh curl

      - name: åŒæ­¥æœ€è¿‘3ä¸ªä¸Šæ¸¸ Releases
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥ä¸Šæ¸¸æœ€è¿‘3ä¸ªæ­£å¼ç‰ˆæœ¬..."

          # è·å–æœ€è¿‘ 10 æ¡ release å¹¶è¿‡æ»¤æ‰ Pre-release
          gh release list -R "$SRC_REPO" --limit 10 | grep -v "Pre-release" | grep -vE '^TITLE' | head -n 3 > releases.txt

          if [[ ! -s releases.txt ]]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æ­£å¼ release"
            exit 0
          fi

          echo "ğŸ“‹ å°†è¦åŒæ­¥çš„ç‰ˆæœ¬åˆ—è¡¨ï¼š"
          cat releases.txt
          echo "--------------------------------"

          while read -r line; do
            tag=$(echo "$line" | awk '{print $3}')   # âœ… ç¬¬3åˆ—æ‰æ˜¯TAG
            if [[ -z "$tag" ]]; then
              continue
            fi

            echo "âš™ï¸ å¤„ç† Release: $tag"

            if gh release view "$tag" -R "$DST_REPO" &>/dev/null; then
              echo "âœ… $tag å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
              continue
            fi

            echo "ğŸ“¦ è·å–ä¸Šæ¸¸ Release ä¿¡æ¯..."
            if ! gh release view "$tag" -R "$SRC_REPO" --json name,body,assets > release.json; then
              echo "âš ï¸ æ— æ³•è·å– $tagï¼Œè·³è¿‡ã€‚"
              continue
            fi

            name=$(jq -r '.name' release.json)
            body=$(jq -r '.body' release.json)

            echo "ğŸ§© åˆ›å»º Release: $tag"
            gh release create "$tag" -R "$DST_REPO" -t "$name" -n "$body" || true

            assets=$(jq -r '.assets[].url' release.json)
            if [[ -z "$assets" ]]; then
              echo "âš ï¸ æ²¡æœ‰é™„ä»¶ï¼Œè·³è¿‡ä¸Šä¼ ã€‚"
              continue
            fi

            echo "â¬‡ï¸ ä¸‹è½½å¹¶ä¸Šä¼ é™„ä»¶..."
            for asset_url in $assets; do
              filename=$(basename "$asset_url")
              echo "ğŸ“¥ ä¸‹è½½ $filename"
              curl -L -o "$filename" -H "Authorization: token $GITHUB_TOKEN" "$asset_url"
              echo "ğŸ“¤ ä¸Šä¼  $filename"
              gh release upload "$tag" "$filename" -R "$DST_REPO" --clobber || true
            done

            echo "âœ… å®ŒæˆåŒæ­¥: $tag"
            echo "--------------------------------"
          done < releases.txt

          echo "ğŸ‰ æ‰€æœ‰æœ€æ–°3ä¸ªç‰ˆæœ¬åŒæ­¥å®Œæˆã€‚"
