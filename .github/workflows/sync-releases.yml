name: Sync Upstream Releases (from clash-verge-rev)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # 每天 03:00 UTC 自动执行

permissions:
  contents: write

jobs:
  sync_releases:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      - name: 同步上游 Releases
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🚀 开始同步上游 Releases..."
          gh release list -R "$SRC_REPO" --limit 100 > upstream_releases.txt

          # 跳过表头行
          tail -n +2 upstream_releases.txt > releases_clean.txt

          while read -r line; do
            tag=$(echo "$line" | awk '{print $1}')
            if [[ -z "$tag" ]]; then
              continue
            fi
            echo "⚙️ 处理 Release: $tag"

            # 检查目标仓库中是否已存在
            if gh release view "$tag" -R "$DST_REPO" &>/dev/null; then
              echo "✅ $tag 已存在，跳过"
              continue
            fi

            # 获取上游 release 信息
            echo "📦 获取上游 Release 信息..."
            gh release view "$tag" -R "$SRC_REPO" --json name,body,assets > release.json || {
              echo "⚠️ 无法获取 release $tag，跳过"
              continue
            }
            name=$(jq -r '.name' release.json)
            body=$(jq -r '.body' release.json)

            # 创建新 release
            echo "🧩 创建 Release: $tag"
            gh release create "$tag" -R "$DST_REPO"_
