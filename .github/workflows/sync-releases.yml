name: Sync Upstream Releases (from clash-verge-rev)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© 03:00 UTC è‡ªåŠ¨æ‰§è¡Œ

permissions:
  contents: write

jobs:
  sync_releases:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£… GitHub CLI å’Œä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      - name: ä½¿ç”¨ GITHUB_TOKEN ç™»å½• GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GITHUB_TOKEN}" | gh auth login --with-token --hostname github.com
          gh auth status

      - name: åŒæ­¥ä¸Šæ¸¸ Releases
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          echo "ğŸš€ è·å–ä¸Šæ¸¸ Releases åˆ—è¡¨..."
          gh release list -R "$SRC_REPO" --limit 5 || (echo "âŒ è·å–ä¸Šæ¸¸ Releases å¤±è´¥"; exit 1)

          for tag in $(gh release list -R "$SRC_REPO" --limit 100 | awk '{print $1}'); do
            echo "âš™ï¸ å¤„ç† Release: $tag"
            if gh release view "$tag" -R "$DST_REPO" &>/dev/null; then
              echo "âœ… $tag å·²å­˜åœ¨ï¼Œè·³è¿‡"
              continue
            fi

            echo "ğŸ“¦ ä¸‹è½½ä¸Šæ¸¸ Release ä¿¡æ¯..."
            gh release view "$tag" -R "$SRC_REPO" --json name,body,assets > release.json

            name=$(jq -r '.name' release.json)
            body=$(jq -r '.body' release.json)

            echo "ğŸ§© åˆ›å»º Release: $tag"
            gh release create "$tag" -R "$DST_REPO" -t "$name" -n "$body" || true

            echo "â¬‡ï¸ åŒæ­¥é™„ä»¶..."
            for asset_url in $(jq -r '.assets[].url' release.json); do
              filename=$(basename "$asset_url")
              curl -L -o "$filename" -H "Authorization: token $GITHUB_TOKEN" "$asset_url"
              gh release upload "$tag" "$filename" -R "$DST_REPO" --clobber || true
            done

            echo "âœ… å®Œæˆ $tag"
          done
