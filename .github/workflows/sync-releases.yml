name: Sync Latest Upstream Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨æ£€æµ‹ä¸€æ¬¡

permissions:
  contents: write

jobs:
  sync_latest_release:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh curl

      - name: åŒæ­¥æœ€æ–°ä¸Šæ¸¸ Release
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ æ£€æŸ¥ä¸Šæ¸¸æœ€æ–° Release..."
          latest_tag=$(gh release list -R "$SRC_REPO" --limit 1 | tail -n +2 | awk '{print $3}')

          if [[ -z "$latest_tag" ]]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸Šæ¸¸ release"
            exit 0
          fi

          echo "ğŸ” ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $latest_tag"

          if gh release view "$latest_tag" -R "$DST_REPO" &>/dev/null; then
            echo "âœ… æœ¬åœ°å·²å­˜åœ¨ï¼Œæ— éœ€åŒæ­¥ã€‚"
            exit 0
          fi

          echo "ğŸ“¦ è·å–ä¸Šæ¸¸ release ä¿¡æ¯..."
          gh release view "$latest_tag" -R "$SRC_REPO" --json name,body,assets > release.json

          name=$(jq -r '.name' release.json)
          body=$(jq -r '.body' release.json)

          echo "ğŸ§© åˆ›å»º release: $latest_tag"
          gh release create "$latest_tag" -R "$DST_REPO" -t "$name" -n "$body" || true

          assets=$(jq -r '.assets[].url' release.json)
          if [[ -z "$assets" ]]; then
            echo "âš ï¸ æ— é™„ä»¶ï¼Œè·³è¿‡ä¸Šä¼ "
            exit 0
          fi

          echo "â¬‡ï¸ ä¸‹è½½å¹¶ä¸Šä¼ é™„ä»¶..."
          for asset_url in $assets; do
            filename=$(basename "$asset_url")
            echo "ğŸ“¥ ä¸‹è½½ $filename"
            curl -L -o "$filename" -H "Authorization: token $GITHUB_TOKEN" "$asset_url"
            echo "ğŸ“¤ ä¸Šä¼  $filename"
