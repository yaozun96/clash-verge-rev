name: Sync Upstream Releases (Latest 3)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动执行，可改为每天执行

permissions:
  contents: write
  issues: write

jobs:
  sync_releases:
    runs-on: ubuntu-latest

    steps:
      - name: 安装依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh curl

      - name: 同步最近3个上游 Releases
        id: sync
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🚀 开始同步上游最近3个正式版本..."

          # 获取最近10条 release（排除 Pre-release）取前3个
          gh release list -R "$SRC_REPO" --limit 10 | grep -v "Pre-release" | grep -vE '^TITLE' | head -n 3 > releases.txt

          if [[ ! -s releases.txt ]]; then
            echo "❌ 未找到任何正式 release"
            echo "no_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "📋 将要同步的版本列表："
          cat releases.txt
          echo "--------------------------------"

          synced_tags=()

          while read -r line; do
            tag=$(echo "$line" | awk '{print $3}' | tr -d '\r' | xargs)
            echo "🧩 正在处理 TAG: [$tag]"
            if [[ -z "$tag" ]]; then
              continue
            fi

            echo "⚙️ 处理 Release: $tag"

            # 如果目标仓库已存在该 release，跳过
