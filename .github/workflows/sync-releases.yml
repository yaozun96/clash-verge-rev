name: Sync Latest Upstream Release (Manual)

# ğŸ‘‡ æ‰‹åŠ¨è§¦å‘ï¼ˆä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼‰
on:
  workflow_dispatch:

# ğŸ‘‡ å¿…é¡»ï¼šè®© GitHub Actions æœ‰æƒåˆ›å»º/ä¿®æ”¹ Release
permissions:
  contents: write

jobs:
  sync_latest_release:
    name: æ‰‹åŠ¨åŒæ­¥ä¸Šæ¸¸ Release
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£…ä¾èµ–ç¯å¢ƒ
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh curl

      - name: åŒæ­¥ä¸Šæ¸¸æœ€æ–° Release
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev    # ä¸Šæ¸¸ä»“åº“
          DST_REPO: yaozun96/clash-verge-rev           # ä½ çš„ä»“åº“
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥ä¸Šæ¸¸æœ€æ–°æ­£å¼ç‰ˆæœ¬..."

          # è·å–ä¸Šæ¸¸æœ€æ–°æ­£å¼ç‰ˆæœ¬ tagï¼ˆæ’é™¤ Pre-releaseï¼‰
          tag=$(gh release list -R "$SRC_REPO" --limit 10 | grep -v "Pre-release" | awk '{print $(NF-1)}' | head -n 1 | tr -d '\r' | xargs)

          if [[ -z "$tag" ]]; then
            echo "âŒ æœªæ£€æµ‹åˆ°ä¸Šæ¸¸æ­£å¼ç‰ˆæœ¬ï¼Œç»“æŸä»»åŠ¡ã€‚"
            exit 0
          fi

          echo "ğŸ§© æ£€æµ‹åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬ TAG: [$tag]"

          # æ£€æŸ¥ä½ çš„ä»“åº“ä¸­æ˜¯å¦å·²æœ‰æ­¤ç‰ˆæœ¬
          if gh release view "$tag" -R "$DST_REPO" &>/dev/null; then
            echo "âœ… $tag å·²å­˜åœ¨ï¼Œæ— éœ€æ›´æ–°ã€‚"
            exit 0
          fi

          echo "ğŸ“¦ è·å–ä¸Šæ¸¸ Release ä¿¡æ¯..."
          if ! gh release view "$tag" -R "$SRC_REPO" --json name,body,assets > release.json; then
            echo "âš ï¸ æ— æ³•è·å– $tag ä¿¡æ¯ï¼Œä»»åŠ¡ç»“æŸã€‚"
            exit 1
          fi

          name=$(jq -r '.name' release.json)
          body=$(jq -r '.body' release.json)

          echo "ğŸ§© åˆ›å»º Release: $tag"
          gh release create "$tag" -R "$DST_REPO" -t "$name" -n "$body"

          assets=$(jq -r '.assets[].url' release.json)
          if [[ -z "$assets" ]]; then
            echo "âš ï¸ è¯¥ç‰ˆæœ¬æ— é™„ä»¶ï¼Œè·³è¿‡ä¸Šä¼ ã€‚"
            exit 0
          fi

          echo "â¬‡ï¸ å¼€å§‹ä¸‹è½½å¹¶ä¸Šä¼ é™„ä»¶..."
          for asset_url in $assets; do
            filename=$(basename "$asset_url")
            echo "ğŸ“¥ ä¸‹è½½ $filename"
            curl -L -o "$filename" -H "Authorization: token $GITHUB_TOKEN" "$asset_url"
            echo "ğŸ“¤ ä¸Šä¼  $filename"
            gh release upload "$tag" "$filename" -R "$DST_REPO" --clobber || true
          done

          echo "âœ… åŒæ­¥å®Œæˆï¼å·²æˆåŠŸåˆ›å»º/æ›´æ–°ç‰ˆæœ¬: $tag"
