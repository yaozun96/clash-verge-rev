name: Sync Upstream Releases (debug mode)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_releases:
    runs-on: ubuntu-latest
    steps:
      - name: 启用调试输出
        run: |
          set -x
          echo "启动调试模式"

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh curl

      - name: 登录 GitHub CLI（调试）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "使用 GITHUB_TOKEN 登录..."
          echo "${GITHUB_TOKEN}" | gh auth login --with-token --hostname github.com || echo "❌ 登录失败"
          gh auth status || echo "⚠️ 无法验证登录状态"

      - name: 测试 gh 命令是否可用
        run: |
          gh --version
          gh repo view clash-verge-rev/clash-verge-rev || echo "⚠️ 无法访问上游仓库"

      - name: 尝试列出上游 releases（测试）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "🧩 尝试列出上游 releases..."
          gh release list -R clash-verge-rev/clash-verge-rev --limit 5 || echo "❌ 获取失败"

      - name: 输出结论
        run: echo "✅ 调试步骤执行完毕。查看上方输出信息确定哪一步失败。"
