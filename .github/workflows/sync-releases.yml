name: Sync Upstream Releases (Manual Only)

on:
  workflow_dispatch:

jobs:
  sync_releases:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y jq curl
          gh --version || sudo apt install -y gh

      - name: ç™»å½• GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: åŒæ­¥ä¸Šæ¸¸æœ€æ–° Release
        env:
          SRC_REPO: clash-verge-rev/clash-verge-rev
          DST_REPO: yaozun96/clash-verge-rev
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬..."
          tag=$(gh release list -R "$SRC_REPO" --limit 5 | grep -v "Pre-release" | awk '{print $(NF-1)}' | head -n 1)

          if [[ -z "$tag" ]]; then
            echo "âš ï¸ æœªæ£€æµ‹åˆ°ä¸Šæ¸¸ Releaseï¼Œç»“æŸã€‚"
            exit 0
          fi

          echo "ğŸ§© æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬ TAG: $tag"

          if gh release view "$tag" -R "$DST_REPO" &>/dev/null; then
            echo "âœ… $tag å·²å­˜åœ¨ï¼Œæ— éœ€æ›´æ–°ã€‚"
            exit 0
          fi

          echo "ğŸ“¦ è·å–ä¸Šæ¸¸ Release ä¿¡æ¯..."
          info=$(gh release view "$tag" -R "$SRC_REPO" --json name,body,assets)

          name=$(echo "$info" | jq -r '.name')
          body=$(echo "$info" | jq -r '.body')
          assets=$(echo "$info" | jq -r '.assets[].url')

          gh release create "$tag" -R "$DST_REPO" --title "$name" --notes "$body"

          for url in $assets; do
            filename=$(basename "$url")
            echo "â¬‡ï¸ ä¸‹è½½ $filename..."
            curl -L "$url" -o "$filename"
            echo "ğŸ“¤ ä¸Šä¼  $filename..."
            gh release upload "$tag" "$filename" -R "$DST_REPO" --clobber
          do
